<?php
// index.php
?>
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Industrial Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#0f1724; color:#e6eef8; }
    .card { border-radius:12px; box-shadow: 0 6px 18px rgba(0,0,0,.6); background: linear-gradient(180deg,#0b1220, #071024); }
    .badge-running { background:#16a34a; }
    .badge-stopped { background:#ef4444; }
    .metric { font-size:1.25rem; font-weight:700; }
    .gauge { height:70px; width:100%; background:rgba(255,255,255,0.03); border-radius:8px; display:flex; align-items:center; justify-content:center; }
    .small-muted { color:#98a2b3; font-size:.9rem; }
    .grid { display:grid; grid-template-columns: repeat(auto-fill,minmax(320px,1fr)); gap:16px; }
    .controls { gap:8px; display:flex; flex-wrap:wrap; }
  </style>
</head>
<body>
<div class="container py-4">
  <div class="d-flex align-items-center mb-4">
    <h1 class="h3 me-auto">Industrial Devices Dashboard</h1>
    <div class="small-muted">Monitor fridges, lights, ice cream units, reservoirs</div>
  </div>

  <div class="row mb-3">
    <div class="col-md-6">
      <div class="card p-3">
        <h5>Register Device</h5>
        <form id="deviceForm" class="row g-2">
          <div class="col-6">
            <input name="name" id="name" class="form-control" placeholder="Device name" required>
          </div>
          <div class="col-6">
            <select name="type" id="type" class="form-select" required>
              <option value="">Select type</option>
              <option>Fridge</option>
              <option>Light</option>
              <option>IceCreamMachine</option>
              <option>WaterReservoir</option>
            </select>
          </div>
          <div class="col-8">
            <input name="location" id="location" class="form-control" placeholder="Location (e.g. Warehouse 1)">
          </div>
          <div class="col-4 d-flex align-items-center">
            <button class="btn btn-primary w-100" type="submit">Create</button>
          </div>
        </form>
        <div id="createMsg" class="mt-2 small-muted"></div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card p-3">
        <h5>Controls</h5>
        <div class="controls mt-2">
          <button id="refreshBtn" class="btn btn-outline-light btn-sm">Refresh Now</button>
          <button id="simulateAllBtn" class="btn btn-outline-warning btn-sm">Simulate Readings</button>
          <button id="clearReadingsBtn" class="btn btn-outline-danger btn-sm">Clear Readings (dev)</button>
        </div>
        <div class="small-muted mt-2">Auto-refresh every 8s</div>
      </div>
    </div>
  </div>

  <div id="devicesGrid" class="grid mb-4"></div>

  <div class="card p-3">
    <h5>All Devices (table)</h5>
    <div class="table-responsive">
      <table class="table table-sm table-dark align-middle" id="devicesTable">
        <thead>
          <tr><th>ID</th><th>Name</th><th>Type</th><th>Location</th><th>Status</th><th>Latest</th><th>Actions</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

</div>

<script>
const api = (action, method='GET', body=null) => {
  let url = `api.php?action=${action}`;
  const opts = { method, headers: {} };
  if (body) { opts.headers['Content-Type'] = 'application/json'; opts.body = JSON.stringify(body); }
  return fetch(url, opts).then(r => r.json());
};

async function fetchDevices(){
  const res = await api('devices');
  if (!res.ok) return console.error('Failed to fetch', res);
  renderDevices(res.devices);
}

function renderDevices(devices){
  const grid = document.getElementById('devicesGrid');
  grid.innerHTML = '';
  const tbody = document.querySelector('#devicesTable tbody');
  tbody.innerHTML = '';

  devices.forEach(d => {
    const badge = d.status === 'running' ? '<span class="badge badge-running">RUNNING</span>' : '<span class="badge badge-stopped">STOPPED</span>';
    // latest readings as quick summary
    const latest = d.readings.length ? d.readings[0].key + ': ' + d.readings[0].value : '—';

    // build card html
    const card = document.createElement('div');
    card.className = 'card p-3';
    card.innerHTML = `
      <div class="d-flex align-items-start mb-2">
        <div class="me-3">
          <div class="small-muted">${d.type}</div>
          <div class="h6 mb-0">${escapeHtml(d.name)}</div>
          <div class="small-muted">${escapeHtml(d.location || '')}</div>
        </div>
        <div class="ms-auto text-end">
          ${badge}
          <div class="small-muted">${new Date(d.created_at).toLocaleString()}</div>
        </div>
      </div>
      <div class="gauge mb-2" data-device="${d.id}">
        <div>
          <div class="metric" id="metric-${d.id}">${d.readings.length ? (d.readings[0].key + ': ' + d.readings[0].value) : 'No data'}</div>
          <div class="small-muted">Last ${d.readings.length ? d.readings[0].created_at : '—'}</div>
        </div>
      </div>
      <div class="d-flex justify-content-between">
        <div>
          <button class="btn btn-sm btn-outline-light btn-sim" data-id="${d.id}">Simulate</button>
          <button class="btn btn-sm btn-outline-primary btn-toggle" data-id="${d.id}" data-status="${d.status}">${d.status === 'running' ? 'Stop' : 'Start'}</button>
        </div>
        <div class="small-muted">Readings: ${d.readings.length}</div>
      </div>
    `;
    grid.appendChild(card);

    // table row
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${d.id}</td><td>${escapeHtml(d.name)}</td><td>${escapeHtml(d.type)}</td>
      <td>${escapeHtml(d.location||'')}</td>
      <td>${d.status}</td>
      <td>${latest}</td>
      <td>
        <button class="btn btn-sm btn-outline-light btn-sim" data-id="${d.id}">Sim</button>
        <button class="btn btn-sm btn-outline-primary btn-toggle" data-id="${d.id}" data-status="${d.status}">${d.status === 'running' ? 'Stop' : 'Start'}</button>
      </td>`;
    tbody.appendChild(tr);
  });

  // attach handlers
  document.querySelectorAll('.btn-sim').forEach(b => b.onclick = async e => {
    const id = e.currentTarget.dataset.id;
    await api('simulate_reading','POST',{device_id:id});
    await fetchDevices();
  });

  document.querySelectorAll('.btn-toggle').forEach(b => b.onclick = async e => {
    const id = e.currentTarget.dataset.id;
    const cur = e.currentTarget.dataset.status;
    const nxt = cur === 'running' ? 'stopped' : 'running';
    await api('device_update_status','POST',{device_id:id,status:nxt});
    await fetchDevices();
  });
}

document.getElementById('deviceForm').onsubmit = async function(ev){
  ev.preventDefault();
  const name = document.getElementById('name').value.trim();
  const type = document.getElementById('type').value;
  const location = document.getElementById('location').value.trim();
  if (!name || !type) return;
  const res = await api('device_create','POST',{name,type,location,metadata:{}});
  const msg = document.getElementById('createMsg');
  if (res.ok) { msg.textContent = 'Device created.'; this.reset(); fetchDevices(); }
  else msg.textContent = 'Failed: ' + (res.error || 'unknown');
};

document.getElementById('refreshBtn').addEventListener('click', fetchDevices);
document.getElementById('simulateAllBtn').addEventListener('click', async () => {
  const list = (await api('devices')).devices || [];
  for (const d of list) {
    await api('simulate_reading','POST',{device_id:d.id});
  }
  fetchDevices();
});
document.getElementById('clearReadingsBtn').addEventListener('click', async () => {
  // quick dev helper to clear readings
  if (!confirm('Clear all readings?')) return;
  await fetch('clear_readings.php');
  fetchDevices();
});

function escapeHtml(s){ if(!s) return ''; return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

let auto = setInterval(fetchDevices, 8000);
fetchDevices();
</script>
</body>
</html>
